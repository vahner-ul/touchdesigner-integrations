## Телеграм-бот для REX Lab

Этот каталог содержит скрипт `telegram-bot.mjs`, который поднимает:
- HTTPS WebSocket-сервер (WSS) для связи с клиентами (например, TouchDesigner);
- Телеграм-бота на базе Telegraf, пересылающего входящие сообщения/фото всем подключённым WS‑клиентам;
- Автоответ на входящие текстовые сообщения через OpenAI API (на языке исходного сообщения).

### Требования
- Node.js 18+;
- Доменное имя и валидные TLS‑сертификаты (или самоподписанные для тестов);
- Токен Телеграм‑бота (у `@BotFather`);
- Ключ OpenAI API (для автоответов);
- Открытые порты:
  - `4043` — WSS (по умолчанию в коде);
  - `4020` — входящий вебхук Telegraf (по умолчанию в коде).

### Структура и важные файлы
- `telegram-bot.mjs` — основной скрипт бота и WSS‑сервера;
- `ssl/certificate.mjs` — модуль с TLS‑настройками (ключ, сертификат и пр.).

Пример `ssl/certificate.mjs` (адаптируйте под свои пути):
```js
import fs from 'fs';

export default {
  key: fs.readFileSync('/path/to/privkey.pem'),
  cert: fs.readFileSync('/path/to/fullchain.pem'),
};
```

### Настройка переменных в `telegram-bot.mjs`
Откройте `telegram-bot.mjs` и укажите:
- `HOST` — ваш домен (например, `rex.example.com`);
- `BOT_TOKEN` — токен бота из `@BotFather`;
- `WSS_PORT` — порт WSS (по умолчанию `4043`);
- `apiKey` — ключ OpenAI API.

Фрагмент для ориентира:
```js
const HOST = '<SERVER_HOST>';
const BOT_TOKEN = '<PASTE_YOUR_TOKEN_HERE>';
const WSS_PORT = 4043;

const apiKey = '<PASTE_API_KEY>'; // OpenAI API key
```

Важно: в коде указаны дефолтные значения портов и путей, при необходимости измените под свою инфраструктуру.

### Установка зависимостей
Перейдите в корень проекта и установите зависимости, если ещё не установлены:
```bash
cd touchdesigner-integrations/telegram
npm install
```

Если проект использует `pnpm`/`yarn`, применяйте соответствующий менеджер пакетов.

### Запуск
```bash
node telegram-bot.mjs
```

После старта в консоли вы увидите что-то вроде:
```
Websocket HTTPS server running wss://<ваш-домен>:4043
```

Бот автоматически поднимет HTTPS‑вебхук Telegraf на `https://<HOST>:4020/rexlab_bot_api` с TLS из `ssl/certificate.mjs`.

### Подключение клиентов по WebSocket
Подключайте клиентов к:
```
wss://<ваш-домен>:4043
```
Бот рассылает всем подключённым клиентам:
- текст входящих сообщений из Телеграма;
- бинарные данные изображений (если пользователи шлют фото боту).

### Поведение бота
- Команды/кнопки:
  - "Help" — краткая справка;
  - "Status" или `/status` — показывает число подключённых WS‑клиентов.
- Текстовые сообщения: бот пересылает текст всем WS‑клиентам и отвечает отправителю коротким саркастическим сообщением через OpenAI (на языке исходного текста).
- Фото: бот скачивает фото и отправляет его бинарные данные всем WS‑клиентам по WSS.

### Настройка вебхука (если требуется вручную)
Telegraf в скрипте уже конфигурируется на вебхук:
```js
telegram: {
  webhook: {
    domain: HOST,
    hookPath: '/rexlab_bot_api',
    port: 4020,
    tlsOptions: certificate,
  }
}
```
Убедитесь, что:
- DNS указывает на ваш сервер;
- порты 4020 и 4043 открыты во внешнюю сеть;
- сертификаты корректные.

### Безопасность и сертификаты
- Для продакшена используйте валидные сертификаты (Let’s Encrypt и т.п.);
- Самоподписанные подойдут лишь для локальных тестов (Телеграм может не принять такой вебхук);
- Храните `BOT_TOKEN` и `apiKey` в секрете (переменные окружения предпочтительнее).

### Отладка
- Проверяйте логи в консоли: подключения WS‑клиентов, ошибки, ответы OpenAI;
- Если автоответы не приходят — проверьте `apiKey` и доступ к `https://api.openai.com`;
- Если `Status` показывает 0 клиентов — убедитесь, что клиенты подключаются к правильному `wss://<HOST>:<WSS_PORT>` и что сертификаты валидны.

### Частые вопросы
- Можно ли использовать другой порт? — Да, измените `WSS_PORT` и/или `webhook.port` в коде и пробросьте их в фаерволе/прокси.
- Можно ли отключить OpenAI‑автоответы? — Да, уберите вызов `askChatGPT` и/или не задавайте `apiKey`.
- Можно ли отправлять файлы кроме фото? — В скрипте реализована обработка `photo`. Добавьте нужные хендлеры Telegraf для других типов.

### Лицензия
См. корневой `LICENSE` репозитория.


